<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>libsimdpp: Dynamic dispatch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="main">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libsimdpp
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Dynamic dispatch </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>If the user wants to include several versions of the same code, compiled for different architectures sets into the same executable, then all such code <em>must</em> be put into <code>SIMDPP_ARCH_NAMESPACE</code> namespace. This macro evaluates to an identifier which is unique for each architecture.</p>
<p>In addition to the above, the source file must not define any of the architecture select macros; they must be supplied via the compiler options. The code for <code>NONE_NULL</code> architecture must be linked to the resulting executable.</p>
<p>To use dynamic dispatch mechanism, declare the function within an <code>SIMDPP_ARCH_NAMESPACE</code> and then use one of <code>SIMDPP_MAKE_DISPATCHER_***</code> macros.</p>
<h2>Dynamic dispatch example</h2>
<p>The following example demonstrates the simpliest usage of dynamic dispatch:</p>
<div class="fragment"><div class="line"><span class="comment">// test.h</span></div>
<div class="line"><span class="keywordtype">void</span> print_arch();</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// test.cc</span></div>
<div class="line"><span class="preprocessor">#include &quot;test.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;simdpp/simd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>SIMDPP_ARCH_NAMESPACE {</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> print_arch()</div>
<div class="line">{</div>
<div class="line">    std::cout &lt;&lt; static_cast&lt;unsigned&gt;(<a class="code" href="a00420.html#ga76a7e1d9682d0b80ae217d881ebd4b56" title="Returns the instruction set flags that will be required by the currently compiled code...">simdpp::this_compile_arch</a>()) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">} <span class="comment">// namespace SIMDPP_ARCH_NAMESPACE</span></div>
<div class="line"></div>
<div class="line">SIMDPP_MAKE_DISPATCHER_VOID0(print_arch);</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// main.cc</span></div>
<div class="line"><span class="preprocessor">#include &quot;test.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    print_arch();</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="preprocessor">#Makefile</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">CXXFLAGS=<span class="stringliteral">&quot;-std=c++11&quot;</span></div>
<div class="line"></div>
<div class="line">test: main.o test_sse2.o test_sse3.o test_sse4_1.o test_null.o</div>
<div class="line">    g++ $^ -lpthread -o test</div>
<div class="line"></div>
<div class="line">main.o: main.cc</div>
<div class="line">    g++ main.cc $(CXXFLAGS) -c -o main.o</div>
<div class="line"></div>
<div class="line"># inclusion of <a class="code" href="a00420.html#gga5335c7b7726de1a63a10b2975ad430b4a91defaee20407d9afa24e2b5951fe050" title="Indicates that no SIMD instructions are supported. ">NONE_NULL</a> is mandatory</div>
<div class="line">test_null.o: test.cc</div>
<div class="line">    g++ test.cc -c $(CXXFLAGS) -o test_sse2.o</div>
<div class="line"></div>
<div class="line">test_sse2.o: test.cc</div>
<div class="line">    g++ test.cc -c $(CXXFLAGS) -DSIMDPP_ARCH_X86_SSE2 -msse2 -o test_sse2.o</div>
<div class="line"></div>
<div class="line">test_sse3.o: test.cc</div>
<div class="line">    g++ test.cc -c $(CXXFLAGS) -DSIMDPP_ARCH_X86_SSE3 -msse3 -o test_sse3.o</div>
<div class="line"></div>
<div class="line">test_sse4_1.o: test.cc</div>
<div class="line">    g++ test.cc -c $(CXXFLAGS) -DSIMDPP_ARCH_X86_SSE4_1 -msse4.1 -o test_sse3.o</div>
</div><!-- fragment --><p>If compiled, the above example selects the "fastest" of SSE2, SSE3 or SSE4.1 instruction sets, whichever is available on the target processor and outputs an integer that identifiers that instruction set.</p>
<p>Note, that the object files must be linked directly to the executable. If static libraries are used, the linker may throw out static dispatcher registration code and break the mechanism. Do prevent this behavior, <code>-Wl</code>,&ndash;whole-archive or an equivalent flag must be used.</p>
<h2>CMake</h2>
<p>For CMake users, <code>cmake/SimdppMultiarch.cmake</code> contains several useful functions:</p>
<ul>
<li><code>simdpp_get_compilable_archs</code>: checks what architectures are supported by the compiler.</li>
<li><code>simdpp_get_runnable_archs</code>: checks what architectures are supported by both the compiler and the current processor.</li>
<li><code>simdpp_multiversion</code>: given a list of architectures (possibly generated by <code>simdpp_get_compilable_archs</code> or <code>simdpp_get_runnable_archs</code>), automatically configures compilation of additional objects. The user only needs to add the returned list of source files to <code>add_library</code> or <code>add_executable</code>.</li>
</ul>
<p>The above example may be build with <code>CMakeLists.txt</code> as simple as follows:</p>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 2.8.0)</div>
<div class="line">project(test)</div>
<div class="line"></div>
<div class="line">include(SimdppMultiarch)</div>
<div class="line"></div>
<div class="line">simdpp_get_runnable_archs(RUNNABLE_ARCHS)</div>
<div class="line">simdpp_multiarch(GEN_ARCH_FILES test.cc ${RUNNABLE_ARCHS})</div>
<div class="line">add_executable(test main.cc ${GEN_ARCH_FILES})</div>
<div class="line">target_link_libraries(test pthread)</div>
<div class="line">set_target_properties(test PROPERTIES COMPILE_FLAGS <span class="stringliteral">&quot;-std=c++11&quot;</span>)</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Apr 8 2014 03:14:34 for libsimdpp by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.4
</small></address>
</div>
</body>
</html>
